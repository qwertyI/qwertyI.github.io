<!DOCTYPE html>
<html lang="zh">

<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="canonical" href="https://y503869692.github.io/html-jacoco-coverage-rete.html" />

    <title>  Ning's Blog &mdash; Jacoco获取单元测试覆盖率
</title>




    <link rel="stylesheet" href="https://y503869692.github.io/theme/css/style.css">

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->


    <meta name="author" content="Ning">
    <meta name="description" content="Test Coverage Rate">
  <meta name="tags" contents="test, ">
</head>

<body>
<header class="header">
  <div class="container">
    <div class="header-inner">
      <h1 class="header-name">
        <a class="nodec" href="https://y503869692.github.io">Ning's Blog</a>
      </h1>
      <h3 class="header-text"></h3>
      <ul class="header-menu list-inline">
          <li><a class="nodec icon-mail-alt" href="mailto:727665171@qq.com"></a></li>
          <li><a class="nodec icon-github" href="https://github.com/y503869692"></a></li>
      </ul>
    </div>
  </div>
</header> <!-- /.header -->  <div class="container">
  <div class="post full-post">
    <h1 class="post-title">
      <a href="/html-jacoco-coverage-rete.html" title="Permalink to Jacoco获取单元测试覆盖率">Jacoco获取单元测试覆盖率</a>
    </h1>
    <ul class="list-inline">
      <li class="post-date">
        <a class="text-muted" href="/html-jacoco-coverage-rete.html" title="2017-02-20T10:20:00">一 20 二月 2017</a>
      </li>
      <li class="muted">&middot;</li>
      <li class="post-category">
        <a href="https://y503869692.github.io/category/jacoco.html">Jacoco</a>
      </li>
        <li class="muted">&middot;</li>
        <li>
            <a href="https://y503869692.github.io/tag/test.html">test</a>        </li>
    </ul>
    <div class="post-content">
      <h2>什么是JaCoCo</h2>
<p>JaCoCo is a free code coverage library for Java, which has been created by the EclEmma team based on the lessons learned from using and integration existing libraries for many years.</p>
<h2>在Android Studio中使用它</h2>
<p>Jacoco在AS中的使用非常简单，下面是配置代码</p>
<div class="highlight"><pre><span></span><span class="x">apply plugin: &#39;com.android.application&#39;</span>

<span class="x">android </span><span class="err">{</span><span class="x"></span>
<span class="x">    compileSdkVersion 19</span>
<span class="x">    buildToolsVersion &quot;22.0.0&quot;</span>

<span class="x">    defaultConfig </span><span class="err">{</span><span class="x"></span>
<span class="x">        applicationId &quot;com.percolata.fusionsensor&quot;</span>
<span class="x">        testInstrumentationRunner &quot;android.support.test.runner.AndroidJUnitRunner&quot;</span>
<span class="x">        minSdkVersion 19</span>
<span class="x">        targetSdkVersion 19</span>
<span class="x">    }</span>

<span class="x">        sourceSets.main </span><span class="err">{</span><span class="x"></span>
<span class="x">        jniLibs.srcDir &#39;libs&#39;</span>
<span class="x">        jni.srcDirs = []</span>
<span class="x">    }</span>

<span class="x">    buildTypes </span><span class="err">{</span><span class="x"></span>
<span class="x">        debug </span><span class="err">{</span><span class="x"></span>
<span class="x">            testCoverageEnabled = true</span>
<span class="x">        }</span>
<span class="x">        release </span><span class="err">{</span><span class="x"></span>
<span class="x">            minifyEnabled false</span>
<span class="x">            proguardFiles getDefaultProguardFile(&#39;proguard-android.txt&#39;), &#39;proguard-rules.txt&#39;</span>
<span class="x">        }</span>
<span class="x">    }</span>

<span class="x">    jacoco</span><span class="err">{</span><span class="x"></span>
<span class="x">        version &quot;0.7.4.201502262128&quot;</span>
<span class="x">    }</span>
<span class="x">}</span>

<span class="x">task jacocoTestReport(type:JacocoReport,dependsOn:&quot;connectedAndroidTest&quot;)</span><span class="err">{</span><span class="x"></span>
<span class="x">    group = &quot;Reporting&quot;</span>
<span class="x">    description = &quot;Generate Jacoco coverage reports after running tests.&quot;</span>
<span class="x">    reports</span><span class="err">{</span><span class="x"></span>
<span class="x">        xml.enabled = false</span>
<span class="x">        html.enabled = true</span>
<span class="x">        csv.enabled = false</span>
<span class="x">    }</span>
<span class="x">    classDirectories = fileTree(</span>
<span class="x">            dir : &quot;</span><span class="p">$</span><span class="nv">buildDir</span><span class="x">/intermediates/classes/debug&quot;,</span>
<span class="x">            excludes : [</span>
<span class="x">                    &#39;**/*Test.class&#39;,</span>
<span class="x">                    &#39;**/R.class&#39;,</span>
<span class="x">                    &#39;**/R</span><span class="p">$</span><span class="x">*.class&#39;,</span>
<span class="x">                    &#39;**/BuildConfig.*&#39;,</span>
<span class="x">                    &#39;**/Manifest*.*&#39;</span>
<span class="x">            ]</span>
<span class="x">    )</span>
<span class="x">    def coverageSourceDirs = [&#39;src/main/java&#39;]</span>
<span class="x">    additionalSourceDirs = files(coverageSourceDirs)</span>
<span class="x">    sourceDirectories = files(coverageSourceDirs)</span>
<span class="x">    additionalClassDirs = files(coverageSourceDirs)</span>
<span class="x">    executionData = files(&quot;</span><span class="p">$</span><span class="nv">buildDir</span><span class="x">/outputs/code-coverage/connected/coverage.ec&quot;)</span>
<span class="x">}</span>

<span class="x">dependencies </span><span class="err">{</span><span class="x"></span>
<span class="x">    compile &#39;com.android.support:support-v4:19.1.0&#39;</span>
<span class="x">}</span>
</pre></div>


<p>将上面的代码放入到build.gradle中，就可以使用<code>./gradlew jacocoTestReport</code>生成测试文件。</p>
<h2>碰到的坑</h2>
<p>一个人战斗有一个很不好的地方就是碰到新东西总会不可避免的掉进一个又一个坑里面，很多人放弃了，活下来的都是勇士。</p>
<p><strong>坑1：难以自拔的想要自己加入jar包</strong></p>
<p>由于对于AS和gradle的不熟悉（公司主要精力放到Python），搜索时使用Ant配置总会要求加入两个文件jacocoAnt.jar和jacocoagent.jar。</p>
<p>但是真正的使用方法是</p>
<div class="highlight"><pre><span></span>apply plugin: &#39;jacoco&#39;

jacoco {
    toolVersion = &quot;0.7.5.201505241946&quot;
}
</pre></div>


<p>这样就可以把jacoco的所有依赖都加入到工程中。找到怎么在gradle中使用jacoco最起码浪费了一天。</p>
<p><strong>坑2：.ec是什么鬼</strong></p>
<p>很幸运的在google中找到了jacoco的所有配置文件，但是运行完之后发现并没有单元测试覆盖率的报告，只有单元测试的结果。并且在coverage/connected中发现一个coverage.ec文件。而在一番google后，在stackoverflow找到一个答案说，使用jacoco的另一个包可以将这个文件解析成覆盖率文件。。于是很傻很天真的我就开始找怎么解析。。呵呵！实际情况是：<strong>当你的单元测试有失败的test时，jacoco不会生成覆盖率文件。</strong></p>
<h2>后续</h2>
<p>以上只是jacoco的简单用法，后续还要继续走在单元测试的道路上：
<strong>1.python代码的单元测试覆盖率。</strong>公司绝大部分代码都是python写的，这部分的单元测试用例因为时间原因无法及时更新，但是后续肯定也要开展开来。
<strong>-</strong>
<strong>2.jenkins集成。</strong>手工测试外的一切的测试如果没有报告，没有自动化都是耍流氓。集成的jenkins之后自动发报，自动执行。这也是公司的大目标之一：尽可能的使用代码来代替人工。
<strong>-</strong>
<strong>3.自动化测试的代码覆盖率。</strong>公司有两个APP，一个是系统级别的，整个机器只供这个APP使用。一个是应用级别的，供客户使用。后续肯定要对手机端的应用级别APP进行自动化测试，而得到代码覆盖率也是目标之一。</p>
    </div>
  </div>
  <hr class="separator">
  <div class="col-md-8 col-md-offset-2">
  </div>
  </div>
<footer class="footer">
  <div class="container">
    <p class="text-center">
      Ning, <a href="" target="_blank"></a> unless otherwise noted.
    </p>
    <div class="text-center">
      Generated by <a href="http://getpelican.com" target="_blank">Pelican</a> with the <a href="http://github.com/nairobilug/pelican-alchemy">alchemy</a> theme.
    </div>
  </div>
</footer> <!-- /.footer -->
  <script src="https://y503869692.github.io/theme/js/jquery.min.js"></script>
  <script src="https://y503869692.github.io/theme/js/bootstrap.min.js"></script>
</body> <!-- 42 -->

</html>